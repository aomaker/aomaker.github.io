---
title: ğŸ”„é‡è¯•æœºåˆ¶
author: Ancient One
date: 2022-06-26
category: Jekyll
layout: post
---
ä¸ºäº†å¢å¼ºæµ‹è¯•ä»£ç çš„å¥å£®æ€§ï¼Œ`aomaker`æä¾›äº†ä¸€ç§é‡è¯•æœºåˆ¶ï¼Œä¸‹é¢é’ˆå¯¹ä¸‰ç§ä½¿ç”¨åœºæ™¯æ¥åšè¯´æ˜ã€‚
###  1.ç½‘ç»œè¯·æ±‚
åœ¨`aomaker`çš„`BaseApi`ä¸­ï¼Œå¯¹å‘é€httpè¯·æ±‚è‹¥é‡åˆ°è¯·æ±‚çŠ¶æ€ç å¤§äº400ï¼Œä¼šè‡ªåŠ¨è¿›è¡Œé‡è¯•ã€‚

```python
class BaseApi:
    IS_HTTP_RETRY = False
    HTTP_RETRY_COUNTS = 3
    HTTP_RETRY_INTERVAL = 2  # å•ä½ï¼šs

    def __init__(self):
        self.cache = Cache()
        self.config = Config().get_all()
        self._host = self.config.get('host')
        self._headers = self.cache.get('headers')
        self._response_callback = response_callback
```

è¿™é‡Œæœ‰ä¸‰ä¸ªå‚æ•°æ¥æ§åˆ¶httpè¯·æ±‚æ—¶çš„é‡è¯•é€»è¾‘ï¼š
- IS_HTTP_RETRY ï¼šæ€»å¼€å…³ï¼Œé»˜è®¤å…³é—­é‡è¯•
- HTTP_RETRY_COUNTSï¼šé‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤3æ¬¡
- HTTP_RETRY_INTERVALï¼šæ¯æ¬¡é‡è¯•é—´éš”çš„æ—¶é—´ï¼Œé»˜è®¤2ç§’ï¼ˆå•ä½ç§’ï¼‰

é‚£å¦‚ä½•æ¥ä¿®æ”¹è¿™äº›å‚æ•°å‘¢?
å‰é¢è¯´è¿‡ï¼Œé¡¹ç›®çš„æ‰€æœ‰aoéƒ½æ˜¯ç»§æ‰¿äºè¿™ä¸ªåŸºç±»ï¼Œæ‰€ä»¥å¯ä»¥ç»§æ‰¿è¯¥åŸºç±»ï¼Œå®ç°ä¸€ä¸ªé¡¹ç›®çš„å­ç±»ã€‚

```python
from aomaker.base.base_api imoort BaseApi


class MyBaseApi(BaseApi):
    IS_HTTP_RETRY = True
    HTTP_RETRY_COUNTS = 5
    HTTP_RETRY_INTERVAL = 3
```

ç„¶åæ‰€æœ‰çš„aoç»§æ‰¿äºè¯¥ç±»å³å¯ï¼Œè¿™æ ·å½“æ‰€æœ‰httpè¯·æ±‚å¦‚æœå‡ºç°ç½‘ç»œè¯·æ±‚çŠ¶æ€ç >400åï¼Œå°†ä¼šæ¯3ç§’é‡è¯•ä¸€æ¬¡ï¼Œæ€»å…±é‡è¯•5æ¬¡ã€‚

### 2.ä¸šåŠ¡å±‚é¢
é™¤äº†åœ¨ç½‘ç»œè¯·æ±‚å±‚é¢ï¼Œè¿˜å¯ä»¥åœ¨ä¸šåŠ¡å±‚é¢åŠ å…¥é‡è¯•ï¼Œè¿›ä¸€æ­¥åŠ å¼ºå¥å£®æ€§ã€‚

æ¯”å¦‚ï¼Œå¯ä»¥æ ¹æ®ä¸šåŠ¡æ¥å£çš„ä¸šåŠ¡ç æ¥åšé‡è¯•ï¼ˆå¤§éƒ¨åˆ†é¡¹ç›®éƒ½ä¼šæœ‰ï¼‰ï¼Œ
å‡å¦‚è¿™é‡Œæœ‰ä¸ªé¡¹ç›®çš„æ‰€æœ‰ä¸šåŠ¡æ¥å£çš„å“åº”éƒ½ä¼šè¿”å›ä¸€ä¸ª`ret_code`ï¼Œå½“è¿™ä¸ª`code`ä¸º0ï¼Œä»£è¡¨ä¸šåŠ¡æ­£å¸¸ï¼Œé0è¡¨ç¤ºå¼‚å¸¸ï¼Œé‚£æˆ‘å¸Œæœ›å½“é0æ—¶ï¼Œè¿›è¡Œä¸€å®šç¨‹åº¦çš„é‡è¯•ï¼Œæ€ä¹ˆåšå‘¢ï¼Ÿ
å¯¼å…¥aomakerçš„é‡è¯•æ¨¡å—ï¼š
```python
from aomaker import aomaker


class Instance(BaseApi):

    @aomaker.retry(counts=2, interval=3, retry_condition=lambda resp: resp.get("ret_code") != 0)
    def get_instances(self):
        http_data = {
            "owner": self.owner,
            "action": "DescribeInstances",
            "reverse": 1,
            "status": ["pending", "running", "stopped", "suspended", "rescuing"],
        }
        resp = self.send_http(http_data)
        return resp
```

`@aomaker.retry(counts=2,interval=3,retry_condition=lambda resp: resp.get("ret_code") != 0)` ,è§£é‡Šä¸‹è¿™ä¸ªè£…é¥°å™¨ï¼š
- counts: è¡¨ç¤ºé‡è¯•æ¬¡æ•°
- intervalï¼šè¡¨ç¤ºé‡è¯•é—´éš”
- retry_conditionï¼šè¡¨ç¤ºé‡è¯•æ¡ä»¶ï¼Œè¿™ä¸ªå‚æ•°æ¥å—ä¸€ä¸ªboolå€¼ï¼Œä¸ºTrueå°±å°†è¿›è¡Œé‡è¯•ï¼Œè¿™é‡Œä¼šæå–è¢«è£…é¥°å‡½æ•°çš„è¿”å›å€¼æ¥è¿›è¡Œåˆ¤æ–­

é™¤äº†è¿™å‡ ä¸ªå‚æ•°ï¼Œè¯¥è£…é¥°å™¨è¿˜æœ‰ä¸€ä¸ªå‚æ•°ï¼š`exception_type`
è¯¥å‚æ•°å¯ä»¥æŒ‡å®šç‰¹å®šå¼‚å¸¸ï¼Œå½“è§¦å‘è¯¥å¼‚å¸¸æ—¶ï¼Œå°†ä¼šè¿›è¡Œé‡è¯•ã€‚

æ —å­ï¼š

```python
@aomaker.retry(counts=2, interval=2, exception_type=TypeError)
def dem(num):
    if num==0:
        raise TypeError
    return num

dem(0)
```

![](https://picgo2listen.oss-cn-beijing.aliyuncs.com/imgs/20231012164710.png)

### 3.ä»£ç ç‰‡æ®µ
é™¤äº†å¯¹å‡½æ•°ã€æ–¹æ³•çº§åˆ«è¿›è¡Œé‡è¯•ï¼Œè¿˜å¯ä»¥é’ˆå¯¹æŸæ®µä»£ç ç‰‡æ®µè¿›è¡Œé‡è¯•ã€‚

ä½¿ç”¨æ–¹æ³•å’Œä¸Šé¢çš„è£…é¥°å™¨ç•¥æœ‰ä¸åŒï¼Œçœ‹æ —å­ï¼š
å…ˆå¯¼å…¥`AoMakerRetry`

```python
from aomaker.aomaker import AoMakerRetry

def get_random_num():
    num = 6
    return num


def demo():
    print('start')
    for attempt in AoMakerRetry(counts=3, interval=2, exception_type=TypeError):
        with attempt:
            print('running...')
            random_ = get_random_num()
            if random_ == 6:
                raise TypeError
    print('end')


demo()
```

è¿™é‡Œéœ€è¦ç”¨`for x in AoMakerRetry() with x:` è¿™æ ·å›ºå®šçš„ç»“æ„ä½“ï¼Œå°†éœ€è¦é‡è¯•çš„ä»£ç ç‰‡æ®µåŒ…è£¹èµ·æ¥ï¼Œè€Œ`AoMakerRetry`ç±»æ‰€æ¥å—çš„å‚æ•°å’Œä¸Šé¢è£…é¥°å™¨æ˜¯ä¸€æ ·çš„ã€‚

ä¸Šé¢ä»£ç çš„è¾“å‡ºç»“æœï¼š
![](https://picgo2listen.oss-cn-beijing.aliyuncs.com/imgs/20231012164735.png)