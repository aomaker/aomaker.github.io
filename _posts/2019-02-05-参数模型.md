---
title: ğŸŒµapiå‚æ•°æ¨¡å‹
author: Ancient One
date: 2019-02-05
category: Jekyll
layout: post
---
å…ˆçœ‹ä¸€ä¸‹æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªç®€å•æ¥å£çš„æ¥å£å®šä¹‰ï¼š
```python
class Instance(BaseApi):
	def get_instances(self):
        http_data = {
            "owner": self.owner,
            "action": "DescribeInstances",
            "reverse": 1,
            "status": ["pending", "running", "stopped", "suspended", "rescuing"],
        }
        resp = self.send_http(http_data)
        return resp
```
å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ¥å£çš„å‚æ•°å…¶å®å¾ˆç®€å•ï¼Œè¿™ä¹ˆå†™æ˜¯okçš„ã€‚

ä½†æ˜¯å¦‚æœä¸€ä¸ªå¤æ‚çš„æ¥å£ï¼Œå¯èƒ½ä¼šæœ‰å‡ åä¸Šç™¾ä¸ªå‚æ•°ï¼Œæ¯”å¦‚ï¼š
```python
class Instance(BaseApi):
	def run_instance(self, å…¥å‚å¯èƒ½å¤ªå¤šçœç•¥...):
	        body = {  
					"image_id": image_id,  
					"instance_type": instance_type,  
					"cpu": cpu,  
					"memory": memory,  
					"instance_name": instance_name,  
					"count": count,  
					"vxnets": vxnets,  
					"nics": nics,  
					"security_group": security_group,  
					"login_mode":login_mode,  
					"login_passwd":login_passwd,  
					"login_keypair":login_keypair,  
					"need_newsid": need_newsid,  
					"need_userdata":need_userdata,  
					"userdata_type":userdata_type,  
					"userdata_value":userdata_value,  
					"userdata_path":userdata_path,  
					"userdata_file":userdata_file,  
					"volumes": volumes,  
					"graphics_protocol": graphics_protocol,  
					"graphics_passwd": graphics_passwd,  
					"boot_dev": boot_dev,  
					"instance_class": instance_class,  
					"usb": usb,  
					"hypervisor": hypervisor,  
					"repl": repl,  
					"gpu": gpu,  
					"gpu_class": gpu_class,  
					"ivshmem": ivshmem,  
					"features": features,  
					"nic_mqueue": nic_mqueue,  
					"stop_on_error": stop_on_error,  
					"sriov_nic_type": sriov_nic_type,  
					"ib_sriov_type": ib_sriov_type,  
					"private_pkey": private_pkey,  
					"os_disk_encryption": os_disk_encryption,  
					"cipher_alg": cipher_alg,  
					"cmk_id": cmk_id,  
					"enable_webssh": enable_webssh, 
					# æ­¤å¤„çœç•¥100ä¸ª 
					}
	        resp = self.send_http(http_data)
	        return resp
```
è¿™æµ·é‡çš„å‚æ•°å¯¹è°ƒç”¨æ–¹å’Œç»´æŠ¤è€…æ¥è¯´éƒ½æ˜¯å·¨å¤§çš„è´Ÿæ‹…ï¼Œå®é™…å¿…ä¼ çš„å‚æ•°å¯èƒ½åªæœ‰å‡ ä¸ªï¼Œä½†æ˜¯åœ¨å®šä¹‰æ¥å£æ—¶ï¼Œæˆ‘ä»¬åˆå¸Œæœ›å®šä¹‰å®Œæ•´å’Œæ¥å£æ–‡æ¡£ä¿æŒä¸€è‡´ï¼ŒåŒ…æ‹¬å‚æ•°è¯¥ä¼ ä»€ä¹ˆç±»å‹ï¼Œå“ªäº›å¿…ä¼ ï¼Œå“ªäº›éå¿…ä¼ ï¼Œé»˜è®¤å€¼æ˜¯ä»€ä¹ˆã€‚

ä»djangoå’Œfastapiä¸­æ‰¾åˆ°ä¸€äº›çµæ„Ÿï¼Œé‚£å°±æ˜¯å‚æ•°æ¨¡å‹ã€‚
é’ˆå¯¹è¿™ç§æœ‰æµ·é‡å‚æ•°çš„æ¥å£ï¼Œå¯ä»¥å°†å‚æ•°å®šä¹‰å•ç‹¬æŠ½è±¡ä¸€å±‚ï¼Œç”±æ¨¡å‹æ¥ç®¡ç†ï¼Œç¼–å†™è€…é€šè¿‡æ¨¡å‹æ¥ç»´æŠ¤å‚æ•°å³å¯ã€‚

å…·ä½“ç”¨æ³•ï¼š
æ¨èåœ¨å¯¹åº”`ao`(æ¥å£å®šä¹‰)ç›®å½•ä¸‹ï¼Œå®šä¹‰ä¸€ä¸ª`model.py` æ¨¡å—
![](https://picgo2listen.oss-cn-beijing.aliyuncs.com/imgs/20231012164437.png)

å¯¼å…¥`aomaker.dataclass` ï¼Œå¯¹å¯¹åº”çš„å‚æ•°ç±»è¿›è¡Œè£…é¥°å³å¯ï¼Œç„¶åç”¨è¿™ä¸ªç±»çš„ç±»å±æ€§æ¥ç®¡ç†æ¥å£çš„æ‰€æœ‰å‚æ•°ã€‚

å¦‚ï¼š
*model.py*
```python
from aomaker import aomaker

from apis.iaas.instance.constants import LoginModeEnum
 
__all__ = ["RunInstanceModel", "DescribeImagesModel"]
 
@aomaker.dataclass 
class RunInstanceModel:
    action: str = "RunInstances"
    image_id: str
    instance_type: str
    cpu: int = None
    memory: int = None
    instance_name: str = None
    os_disk_size: int = None  # å•ä½GB
    count: int = 1
    login_mode: LoginModeEnum = LoginModeEnum.passwd.value
    login_passwd: str = "Zhu@88jie123"
    login_keypair: str = None
    vxnets: str = None  # æ˜¯å¦åŠ å…¥ç§æœ‰ç½‘ç»œ
    security_group: str = None  # vxnetsåŒ…å«åŸºç¡€ç½‘ç»œæ‰éœ€è¦
    volumes: str = None
    hostname: str = None
    need_newsid: int = None  # é»˜è®¤0ï¼Œåªå¯¹windowsç±»ä¸»æœºæœ‰æ•ˆ
    instance_class: int = None  # ä¸»æœºæ€§èƒ½ç±»å‹
    cpu_model: str = None  # CPUæŒ‡ä»¤é›†ï¼Œæœ‰æ•ˆå€¼: Westmere, SandyBridge, IvyBridge, Haswell, Broadwell
    cpu_topology: str = None
    gpu: int = None
    gpu_class: int = None
    nic_mqueue: int = None  # ç½‘å¡å¤šé˜Ÿåˆ—ï¼Œ0å…³é—­ï¼ˆé»˜è®¤ï¼‰ï¼Œ1å¼€å¯

@aomaker.dataclass
class DescribeImagesModel:
    action = "DescribeImages"
    provider: str = "system"
    status: list = ["pending", "available", "suspended"]
    offset: int = None
    limit: int = None
    sort_key: str = "order_name"
    os_family: list = ["centos"]
    search_word: str = ""
```

æ¨¡å‹ä¸­ä¼šå®šä¹‰æ¯ä¸ªæ¥å£çš„æ‰€æœ‰å‚æ•°åŠå…¶ç±»å‹ï¼Œå½“è®¾ç½®ä¸ºNoneæ—¶ï¼Œä»£è¡¨è¯¥å‚æ•°éå¿…å¡«ï¼Œåœ¨å‘é€è¯·æ±‚æ—¶ï¼Œè¯·æ±‚æ„é€ å™¨ä¼šè‡ªåŠ¨è¿‡æ»¤æ‰è¿™äº›éå¿…å¡«ä¸”æ²¡æœ‰ä¼ å€¼çš„å‚æ•°ã€‚

é‚£ä¹ˆåœ¨ä¸€ä¸ªæ¥å£å®šä¹‰ä¸­å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ

```python
from apis.iaas.instance import model


    def run_instances(self, **kw_params):
        """åˆ›å»ºä¸»æœº"""
        params_model = model.RunInstanceModel(**kw_params)
        resp = self.send_http(params_model)
        return resp
```

è¿™ä¸ªæ¥å£çš„æ‰€æœ‰å…¥å‚ï¼Œé€šè¿‡ä¸å®šé•¿å…³é”®å­—å‚æ•°ä¼ å…¥ï¼Œ

å¦‚æœä¼ å…¥äº†å‚æ•°ï¼Œé‚£ä¹ˆä¼šæ›¿æ¢æ¨¡å‹ä¸­çš„é»˜è®¤å€¼ï¼›

å¦‚æœä¼ å…¥äº†æ¨¡å‹ä¸­æ²¡æœ‰çš„å‚æ•°ï¼Œä¼šç›´æ¥æŠ¥é”™ï¼›

å¦‚æœä»€ä¹ˆéƒ½ä¸ä¼ ï¼Œåˆ™é»˜è®¤å–å‚æ•°æ¨¡å‹ä¸­çš„å€¼ï¼Œä¸è¿‡ï¼Œè¦æ³¨æ„æ¨¡å‹ä¸­æ˜¯å¦æœ‰å¿…ä¼ å‚æ•°ã€‚

è¿™æ ·ï¼Œæ•´ä¸ªæ¥å£å®šä¹‰ä¼šéå¸¸æ¸…çˆ½ï¼Œè€Œå¤æ‚çš„æ¥å£å‚æ•°ç®¡ç†å¯ä»¥é€šè¿‡æ¥å£æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆæˆ‘ä»¬è§„å®šçš„æ¨¡å‹æ ¼å¼ï¼Œå•ç‹¬ç®¡ç†ï¼Œè°ƒç”¨æ–¹ä¹Ÿèƒ½éå¸¸æ¸…æ™°çš„çŸ¥é“æ¯ä¸ªå‚æ•°çš„å«ä¹‰ã€æ˜¯å¦å¿…ä¼ æˆ–é»˜è®¤å€¼ç­‰è¯¦ç»†ä¿¡æ¯ã€‚