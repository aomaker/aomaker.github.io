---
title: ğŸŒŠæ–­è¨€æ‰©å±•
author: Ancient One
date: 2022-07-13
category: Jekyll
layout: post
---

# å†…ç½®æ–­è¨€

`aomaker`çš„æ‰€æœ‰æµ‹è¯•ç±»ï¼Œéƒ½ç»§æ‰¿äº`aomaker`æä¾›çš„`BaseTestcase`ç±»ï¼Œè¿™ä¸ªæµ‹è¯•ç±»å†…ç½®äº†ä¸€äº›å¸¸è§çš„æ–­è¨€æ–¹å¼ï¼š

```python
class BaseTestcase:

    @staticmethod
    def assert_eq(actual_value, expected_value):
        """
        equals
        """
        try:
            assert actual_value == expected_value
        except AssertionError as e:
            logger.error(f"eqæ–­è¨€å¤±è´¥ï¼Œé¢„æœŸç»“æœï¼š{expected_value}ï¼Œå®é™…ç»“æœï¼š{actual_value}")
            raise e

    @staticmethod
    def assert_gt(actual_value, expected_value):
        """
        greater than
        """
        try:
            assert actual_value > expected_value
        except AssertionError as e:
            logger.error(f"gtæ–­è¨€å¤±è´¥ï¼Œé¢„æœŸç»“æœï¼š{expected_value}ï¼Œå®é™…ç»“æœï¼š{actual_value}")
            raise e

    @staticmethod
    def assert_lt(actual_value, expected_value):
        """
        less than
        """
        try:
            assert actual_value < expected_value
        except AssertionError as e:
            logger.error(f"ltæ–­è¨€å¤±è´¥ï¼Œé¢„æœŸç»“æœï¼š{expected_value}ï¼Œå®é™…ç»“æœï¼š{actual_value}")
            raise e

    @staticmethod
    def assert_neq(actual_value, expected_value):
        """
        not equals
        """
        try:
            assert actual_value != expected_value
        except AssertionError as e:
            logger.error(f"neqæ–­è¨€å¤±è´¥ï¼Œé¢„æœŸç»“æœï¼š{expected_value}ï¼Œå®é™…ç»“æœï¼š{actual_value}")
            raise e

    @staticmethod
    def assert_ge(actual_value, expected_value):
        """
        greater than or equals
        """
        try:
            assert actual_value >= expected_value
        except AssertionError as e:
            logger.error(f"geæ–­è¨€å¤±è´¥ï¼Œé¢„æœŸç»“æœï¼š{expected_value}ï¼Œå®é™…ç»“æœï¼š{actual_value}")
            raise e

    @staticmethod
    def assert_le(actual_value, expected_value):
        """
        less than or equals
        """
        try:
            assert actual_value <= expected_value
        except AssertionError as e:
            logger.error(f"leæ–­è¨€å¤±è´¥ï¼Œé¢„æœŸç»“æœï¼š{expected_value}ï¼Œå®é™…ç»“æœï¼š{actual_value}")
            raise e

    @staticmethod
    def assert_contains(actual_value, expected_value):
        assert isinstance(
            expected_value, (list, tuple, dict, str, bytes)
        ), "expect_value should be list/tuple/dict/str/bytes type"
        try:
            assert expected_value in actual_value
        except AssertionError as e:
            logger.error(f"containsæ–­è¨€å¤±è´¥ï¼Œé¢„æœŸç»“æœï¼š{expected_value}ï¼Œå®é™…ç»“æœï¼š{actual_value}")
            raise e
```

# jsonschemaä»‹ç»

æ­¤å¤–ï¼Œåœ¨2.0ä¸­è¿˜åŠ å…¥äº†`jsonschema`æ–­è¨€ã€‚

æœ‰æ—¶ï¼Œæˆ‘ä»¬çš„æ¥å£å“åº”æ•°æ®ä½“ç§¯ä¼šéå¸¸åºå¤§ï¼Œå­—æ®µä¹Ÿéå¸¸å¤šï¼Œæˆ‘ä»¬å¸¸è§„çš„æ–­è¨€å¯èƒ½åªä¼šå»å…³æ³¨æŸå‡ ä¸ªå…³é”®å­—æ®µï¼Œä½†æ˜¯è¿™ä¸å¤Ÿå¥å£®ï¼Œæœ‰æ—¶å€™åç«¯â€œæ‚„æ‚„å’ªå’ªâ€åŠ äº†æŸä¸ªå­—æ®µæˆ–è€…åˆ äº†æŸä¸ªå­—æ®µæˆ–è€…æ”¹äº†æŸä¸ªå­—æ®µçš„ç±»å‹ï¼Œæˆ‘ä»¬å¯èƒ½å¾ˆéš¾å¯Ÿè§‰åˆ°ï¼Œè¿™å°±ä¼šå¯¼è‡´ä¸€äº›éšè—çš„bugé€ƒé€¸ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ å¼ºæ–­è¨€çš„å¥å£®åº¦ï¼Œè¦å¯¹æ•´ä¸ªå“åº”å†…å®¹ç»“æ„æœ‰ä¸€ä¸ªåŸºæœ¬çš„æŠŠæ§ã€‚

æ€ä¹ˆåšå‘¢ï¼Œè¿™å°±éœ€è¦ç”¨åˆ°`jsonschema`äº†ã€‚

> JSON Schemaæ˜¯åŸºäºJSONæ ¼å¼ï¼Œç”¨äºå®šä¹‰JSONæ•°æ®ç»“æ„ä»¥åŠæ ¡éªŒJSONæ•°æ®å†…å®¹ã€‚ JSON Schemaå®˜ç½‘åœ°å€ï¼š[http://json-schema.org/](https://link.zhihu.com/?target=http%3A//json-schema.org/)

æ¯”å¦‚æœ‰ä¸€ä¸ªjsonå­—ç¬¦ä¸²ï¼š

```json
{
  "name": "aomaker",
  "age": 2,
  "desc": "api framework"
}
```

è¿™å…¶ä¸­`name`å’Œ`age`æ˜¯å¿…å¡«å­—æ®µï¼Œå­—æ®µç±»å‹åˆ†åˆ«æ˜¯`string`å’Œ`int`ï¼Œå¯é€‰å­—æ®µæ˜¯`desc`ï¼Œå­—æ®µç±»å‹æ˜¯`string`ï¼Œå‡å¦‚æˆ‘æƒ³è¦æ¯ä¸ªè¿™æ ·çš„jsonå­—ç¬¦ä¸²ï¼Œéƒ½ç¬¦åˆä¸Šé¢çš„çº¦æŸï¼Œé‚£æˆ‘æ€ä¹ˆè‡ªåŠ¨å»æ ¡éªŒå‘¢ï¼Ÿè¿™å°±éœ€è¦å®‰è£…`jsonschema`çš„è¯­æ³•å»å†™çº¦æŸæ¡ä»¶ã€‚

**jsonchemaè¯­æ³•**

```json
{
    "$schema": "http://json-schema.org/draft-04/schema#",
    "title": "TestInfo",
    "description": "some information about test",
    "type": "object",
    "properties": {
        "name": {
            "description": "Name of the test",
            "type": "string"
        },
        "age": {
            "description": "age of test",
            "type": "integer"
        }
    },
    "required": [
        "name",
        "age"
    ]
}
```

**å¼€å§‹æ ¡éªŒ**

```python
from jsonschema import validate

x = {
    "name": "aomaker",
    "age": 2,
    "desc": "api framework"
}
schema = {
    "$schema": "http://json-schema.org/draft-04/schema#",
    "title": "TestInfo",
    "description": "some information about test",
    "type": "object",
    "properties": {
        "name": {
            "description": "Name of the test",
            "type": "string"
        },
        "age": {
            "description": "age of test",
            "type": "integer"
        }
    },
    "required": [
        "name"
    ]
}

validate(x, schema)
```

å¦‚æœæ ¡éªŒé€šè¿‡ï¼Œä¼šæ²¡æœ‰è¿”å›ï¼Œä¹Ÿæ²¡æœ‰æŠ¥é”™ã€‚

å‡å¦‚ä¸å°å¿ƒæŠŠ`age`ä¼ æˆäº†å­—ç¬¦ä¸²`"2"`ï¼Œ`jsonschema`æ£€æµ‹åˆ°åï¼Œä¼šç«‹å³æŠ¥é”™

```
jsonschema.exceptions.ValidationError: '2' is not of type 'integer'

Failed validating 'type' in schema['properties']['age']:
{'description': 'age of test', 'type': 'integer'}

On instance['age']:
    '2'
```

å‡å¦‚ä¸å°å¿ƒæ²¡æœ‰ä¼ å¿…å¡«å­—æ®µ`name`ï¼Œä¹Ÿä¼šç«‹å³æŠ¥é”™

```
jsonschema.exceptions.ValidationError: 'name' is a required property

Failed validating 'required' in schema:
    {'$schema': 'http://json-schema.org/draft-04/schema#',
     'description': 'some information about test',
     'properties': {'age': {'description': 'age of test',
                            'type': 'integer'},
                    'name': {'description': 'Name of the test',
                             'type': 'string'}},
     'required': ['name', 'age'],
     'title': 'TestInfo',
     'type': 'object'}

On instance:
    {'age': 2, 'desc': 'api framework'}
```

é€šè¿‡è¿™ç§æ‰‹æ®µæ˜¯ä¸æ˜¯å¯¹æˆ‘ä»¬æµ‹è¯•è¿‡çš„æ¥å£æ›´æœ‰ä¿¡å¿ƒäº†ï¼Ÿ

# æ‰©å±•jsonschemaæ–­è¨€

**ä½†æ˜¯~**æœ‰æ²¡æœ‰å‘ç°ï¼Œ`jsonschema`è™½ç„¶å¾ˆå¥½ï¼Œä½†æ˜¯ä½ å¾—æ‰‹åŠ¨å»å†™`jsonschema`æ ¡éªŒè¯­æ³•ï¼Œä¸Šé¢çš„ç¤ºä¾‹è¿˜å¥½ï¼Œåªæœ‰å‡ ä¸ªå­—æ®µï¼Œä½†å®é™…ä¸šåŠ¡ä¸­ï¼Œå“åº”çš„å­—æ®µå¯èƒ½è¦æ¯”è¿™ä¸ªå¤šå¾—å¤šå¾—å¤šå§ï¼Ÿé‚£æ¯ä¸ªæ¥å£è¿™ä¹ˆå»å†™ï¼Œæˆæœ¬ä¹Ÿå¤ªé«˜äº†ï¼

**æ‰€ä»¥ï¼Œ** `aomaker`æä¾›äº†ä¸€ç§æ‰‹æ®µï¼Œå¯ä»¥è‡ªåŠ¨å»ç”Ÿæˆ`jsonschema`æ ¡éªŒè¯­æ³•~å…¶å®ä¸Šæ–‡æœ‰æåˆ°è¿‡ï¼Œ`aomaker.db`æ•°æ®åº“ä¸­ï¼Œæœ‰ä¸€å¼ è¡¨å«`schema`ï¼Œå…¶å®å®ƒå°±æ˜¯å­˜æ”¾è¯·æ±‚è¿‡çš„æ¯ä¸ªæ¥å£å“åº”çš„`jsonschema`æ ¡éªŒè¯­æ³•çš„ã€‚`aomaker`ä¼šè‡ªåŠ¨è®°å½•æ¯ä¸ªè¯·æ±‚ç¬¬ä¸€æ¬¡è¿”å›å“åº”æ—¶çš„`jsonschema`ï¼Œå½“åœ¨caseå±‚å»åšæ–­è¨€æ—¶ï¼Œ`aomaker`æä¾›äº†ä¸€ä¸ª`jsonschema`çš„æ–­è¨€åœ¨`BaseTestcase`ä¸­ï¼š

```python
class BaseTestcase:
    ...
    @staticmethod
    def assert_schema(instance, api_name):
        """
        Assert JSON Schema
        :param instance: è¯·æ±‚å“åº”ç»“æœ
        :param api_name: å­˜æ”¾åœ¨schemaè¡¨ä¸­çš„å¯¹åº”keyå
        :return: 
        """
        json_schema = Schema().get(api_name)
        if json_schema is None:
            logger.error('jsonschemaæœªæ‰¾åˆ°ï¼')
            raise SchemaNotFound(api_name)
        try:
            validate(instance, schema=json_schema)
        except ValidationError as msg:
            logger.error(msg)
            raise AssertionError
```

åœ¨caseå±‚è¿›è¡Œæ–­è¨€ï¼š

```python
class TestJob(BaseTestcase):

    def test_hpc_submit_job(self):
        resp = job.submit_hpc_job()
        ret_code = resp.get("ret_code")
        self.assert_eq(ret_code, 0)
        # schemaæ–­è¨€
        self.assert_schema(resp, 'submit_hpc_job')

```

ä¼šæ ¹æ®ç¬¬äºŒä¸ªå‚æ•°ï¼Œå»`schema`è¡¨ä¸­å–å¯¹åº”keyçš„`jsonschema`

_schemaè¡¨_

[![jROZuT.md.png](https://s1.ax1x.com/2022/07/13/jROZuT.md.png)](https://imgtu.com/i/jROZuT)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`schema`è¡¨ä¸­çš„`jsonschema`æ˜¯åœ¨æ¥å£è¢«è°ƒç”¨çš„æ—¶å€™è‡ªåŠ¨å­˜å‚¨çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦æ‰‹åŠ¨æ“ä½œï¼Œä½†æ˜¯ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªåŸå› ï¼Œæœ‰å¯èƒ½ä¼šå­˜å‚¨æ¥å£å¼‚å¸¸æ—¶çš„å“åº”çš„ç»“æ„ä½“ï¼Œæ‰€ä»¥å½“è¦åšjsonschemaæ–­è¨€æ—¶ï¼Œè¯·æ£€æŸ¥è¯¥è¡¨ï¼Œç¡®ä¿è¯¥è¡¨å¯¹åº”æ¥å£çš„jsonschemaæ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œå½“ç„¶ï¼Œaomakerä¹Ÿæä¾›äº†ä¸€ä¸ª`genson()`æ–¹æ³•ï¼Œä½ å¯ä»¥é€šè¿‡è¯¥æ–¹æ³•æ‰‹åŠ¨è·å–é¢„æœŸçš„`jsonschema`ï¼Œç„¶åè‡ªå·±å­˜å‚¨åˆ°`schema`è¡¨ä¸­ï¼Œ`schema`è¡¨æ˜¯å›ºåŒ–ä¸ä¼šè‡ªåŠ¨æ¸…ç†çš„ï¼Œä½ å¯ä»¥æŒç»­æ ¡æ­£å’Œç»´æŠ¤è¯¥è¡¨ã€‚

# å¦‚ä½•ä½¿ç”¨`genson`

åªéœ€è¦ä¼ å…¥jsonå­—ç¬¦ä¸²ï¼Œ`genson` ä¼šè‡ªåŠ¨è¿”å›å…¶`jsonschema`ã€‚

```python
# å¯¼å…¥genson
from aomaker.aomaker import genson

x = {
    "age": 2,
    "desc": "api framework"
}

schema = genson(x)

print(schema)

# è¾“å‡ºï¼š
# {'$schema': 'http://json-schema.org/schema#', 'type': 'object', 'properties': {'age': {'type': 'integer'}, 'desc': {'type': 'string'}}, 'required': ['age', 'desc']}
```
