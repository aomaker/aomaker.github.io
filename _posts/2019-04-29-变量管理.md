---
title: ☄️变量管理
author: Ancient One
date: 2019-04-29
category: Jekyll
layout: post
---

为了对多任务运行测试用例有更好的支持，`aomaker` 采用了本地数据库`sqlite`的方案来存储管理变量，`sqlite`是一个非常轻量的本地文件数据库，可以直接访问存储文件，而且不需要任何安装配置~

> SQLite是一个进程内的库，实现了自给自足的、无服务器的、零配置的、事务性的 SQL 数据库引擎。它是一个零配置的数据库，这意味着与其他数据库不一样，您不需要在系统中配置。
> 就像其他数据库，SQLite 引擎不是一个独立的进程，可以按应用程序需求进行静态或动态连接。SQLite 直接访问其存储文件。

当使用aomaker创建完脚手架后，会在`database`目录下创建`aomaker.db`数据库文件，并且aomaker内置了三张数据表，来分别管理全局变量、接口依赖参数、jsonschema，这三张表分别是：

- config：存储配置文件中的全局变量，如账户信息，环境host等配置信息，当启动测试任务后，会根据当前选择的测试环境，自动读取`config.yaml`中的配置存到`config`表中，该配置会固化不清理，除非更改了测试环境。
- cache：存储测试过程中上下游接口之间的依赖接口的响应，会搭配后文将要讲到的`dependece`装饰器使用 。当一个依赖接口被调用后，会存储它完整的response·，如果后续有其它接口也依赖这个接口，那么该接口将不会再被调用，而是直接从该接口存储的response中去读取需要的依赖参数。整个测试任务结束后，会自动清理`cache`表。
- schema：存储接口的`jsonschema`信息，当一个接口第一次被调用后，会自动从它的`response`中解析出`response.json()`的`jsonschema`，在用例层进行断言时，可以对此次接口响应的结构体与`schema`表中存储的结构体进行比较，检测是否有参数变动。（后文细讲）

三张表的结构其实都非常简单，就是键值对：

[![jRL7AH.png](https://s1.ax1x.com/2022/07/13/jRL7AH.png)](https://imgtu.com/i/jRL7AH)

在`aomaker`的`baseapi`中，初始化了`cache`和`config`两张表的连接对象，因为所有接口都是继承于`baseapi`的，所以所有接口都可以通过`self.config`和`self.cache`来拿到连接对象，当有了连接对象就可以通过封装好的`set()`和`get()`方法来存取变量了。

另外，三张表的数据读写，都是做了线程安全的，在多线程模式下也能保证数据安全。
