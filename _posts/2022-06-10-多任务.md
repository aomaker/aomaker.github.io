---
title: ğŸš€å¤šä»»åŠ¡
author: Ancient One
date: 2022-06-10
category: Jekyll
layout: post
---

> `aomaker` æä¾›äº†å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹ä¸¤ç§æ–¹å¼æ¥åŠ é€Ÿç”¨ä¾‹è¿è¡Œé€Ÿåº¦ï¼Œæä¾›äº†ä¸‰ç§ç²’åº¦æ¥åˆç†æ§åˆ¶çº¿ç¨‹/è¿›ç¨‹workerï¼Œæ­¤å¤–ï¼Œå¤šçº¿ç¨‹æ¨¡å¼ä¸‹ï¼Œå¯¹`allure` æŠ¥å‘Šä¹Ÿåšäº†ä¼˜åŒ–ï¼Œä¸ä¼šåƒ`pytest-parallel`å¯èƒ½ä¼šå‡ºç°æ— æ³•æ­£å¸¸ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šçš„é—®é¢˜ã€‚

aomakerçš„è¿è¡Œæµç¨‹å¦‚ä¸‹ï¼š
![[Pasted image 20231010182207.png]]
å¯åŠ¨åï¼Œ
1. è¯»å–`config.yaml` é…ç½®æ–‡ä»¶
2. åŠ è½½é…ç½®æ–‡ä»¶
3. è¿è¡Œ`hooks.py`ä¸­çš„è‡ªå®šä¹‰cliå’Œhookï¼ˆå¦‚æœæœ‰ï¼‰
4. å¼€å§‹æ ¹æ®cliæŒ‡å®šçš„å¤šä»»åŠ¡æ–¹å¼å’Œåˆ†é…æ¨¡å¼å¼€å¯å¤šçº¿ç¨‹/è¿›ç¨‹ï¼ˆå¦‚æœåœ¨`aomaker.yaml`ä¸­æŒ‡å®šäº†workeråˆ†é…ç­–ç•¥ï¼Œå°†ä¼šä»¥è¯¥ç­–ç•¥è¿›è¡Œåˆ†é…ï¼‰
5. åœ¨å­è¿›ç¨‹/çº¿ç¨‹å†…å¯åŠ¨`pytest`è¿›è¡Œç”¨ä¾‹è¿è¡Œ
6. æ‰€æœ‰å­ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œè¿›è¡ŒæŠ¥å‘Šæ”¶é›†ã€èšåˆå’Œç¯å¢ƒæ¸…ç†ï¼Œç»“æŸ


# å¤šçº¿ç¨‹ï¼ˆæ¨èï¼‰

##### å¯åŠ¨æ–¹å¼

`aomaker`æä¾›äº†ä¸¤ç§å¯åŠ¨å¤šçº¿ç¨‹ï¼š**CLI**å’Œ**run.py**

1. cli

```
multi-run:
--mp, --multi-process
specifies a multi-process running mode.
--mt, --multi-thread  specifies a multi-thread running mode.
--dist-suite DIST_SUITE
specifies a dist mode for per worker.
--dist-file DIST_FILE
specifies a dist mode for per worker.
--dist-mark DIST_MARK [DIST_MARK ...]
specifies a dist mode for per worker.

```

å‘½ä»¤è¡Œè¾“å…¥ï¼š`arun --mt --dist-xxx xxx`æˆ–è€…`aomaker run --mt --dist-xxx`

2. run.py

_run.py_

```python
from login import Login

from aomaker.runner import threads_run

if __name__ == '__main__':
    threads_run(['-m ehpc','-m hpc'], login=Login())
```

##### åˆ†é…æ¨¡å¼

ä¸ºäº†æ›´åŠ ç²¾ç»†å’Œåˆç†çš„å»åˆ†é…ä»»åŠ¡ç»™å­çº¿ç¨‹ï¼Œ`aomaker`æä¾›äº†ä¸‰ç§åˆ†é…æ¨¡å¼ï¼Œé¢—ç²’åº¦ç”±ç»†åˆ°ç²—åˆ†åˆ«æ˜¯ï¼š

1. æŒ‰æ ‡è®°åˆ†é…

å³æŒ‰ç…§`pytest`æä¾›çš„`mark`åŠŸèƒ½æ¥åˆ†é…ä»»åŠ¡ç»™å­çº¿ç¨‹ï¼Œæ¯”å¦‚è¯´ä½ å¸Œæœ›å°†æ ‡è®°ä¸º`demo1`ã€`demo2`ã€`demo3`çš„ä¸‰ç»„caseåˆ†é…ç»™ä¸‰ä¸ªä¸åŒå­çº¿ç¨‹å»è·‘ï¼Œé‚£ä¹ˆä½ éœ€è¦åšçš„å°±æ˜¯ï¼šæå‰ç»™ç”¨ä¾‹æ‰“ä¸Šå¯¹åº”`mark`ï¼Œç„¶åï¼š

- cliï¼š`arun --mt --dist-mark demo1 demo2 demo3`
- run.py: 

_run.py_

```python
from login import Login

from aomaker.runner import threads_run

if __name__ == '__main__':
    # æ³¨æ„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥çš„æ˜¯åˆ—è¡¨
    threads_run(['-m demo1','-m demo2','-m demo3'], login=Login())
```

è¿™æ ·å¯åŠ¨åï¼Œä¼šå¼€å¯ä¸‰ä¸ªå­çº¿ç¨‹ï¼Œå»åˆ†åˆ«æ‰§è¡Œä¸‰ç»„caseã€‚

**æ³¨æ„ï¼š**

**1.æ¯ç»„markä¸‹çš„caseï¼Œä¸€å®šè¦ä¿è¯æ˜¯ç‹¬ç«‹çš„ï¼**

**2.æä¾›å¤šå°‘ä¸ªmarkï¼Œå°±å¼€å¯å¤šå°‘ä¸ªçº¿ç¨‹**

2. æŒ‰æµ‹è¯•æ¨¡å—åˆ†é…

å³æŒ‰ç…§æµ‹è¯•æ–‡ä»¶æ¥åˆ†é…ä»»åŠ¡ç»™å­çº¿ç¨‹ï¼Œæ¯”å¦‚åœ¨`testcases\test_api`ç›®å½•ä¸‹æœ‰`test_demo1.py`ã€`test_demo2.py`ã€`test_demo3.py`ä¸‰ä¸ªæµ‹è¯•æ¨¡å—ï¼Œä½ å¸Œæœ›è¿™ä¸‰ä¸ªæ¨¡å—ä¸‹çš„æµ‹è¯•caseåˆ†åˆ«ç”±ä¸‰ä¸ªå­çº¿ç¨‹æ¥ç®¡æ‰§è¡Œï¼Œé‚£ä¹ˆåªéœ€è¦ï¼š

- cliï¼š`arun --mt --dist-file testcases\test_api`ï¼Œå³å‘Šè¯‰`aomaker`æµ‹è¯•æ–‡ä»¶æ‰€åœ¨ç›®å½•æ—¢å¯
- run.py: 

_run.py_

```python
from login import Login

from aomaker.runner import threads_run

if __name__ == '__main__':
    # æ³¨æ„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥çš„æ˜¯keyåä¸ºpathçš„å­—å…¸
    threads_run({"path":"testcases/test_api"}, login=Login())
```

**æ³¨æ„ï¼š**

**1.æ¯ä¸ªæµ‹è¯•æ¨¡å—ä¸‹çš„caseï¼Œä¸€å®šè¦ä¿è¯æ˜¯ç‹¬ç«‹çš„ï¼**

**2.æŒ‡å®šç›®å½•ä¸‹æœ‰å¤šå°‘ä¸ªæµ‹è¯•æ¨¡å—ï¼Œå°±å¼€å¯å¤šå°‘ä¸ªçº¿ç¨‹**

3. æŒ‰æµ‹è¯•å¥—ä»¶åˆ†é…

å³æŒ‰ç…§æµ‹è¯•ç›®å½•æ¥åˆ†é…ä»»åŠ¡ç»™å­çº¿ç¨‹ï¼Œæ¯”å¦‚åœ¨`testcases\test_scenario`ç›®å½•ä¸‹ï¼Œæœ‰`test_scenario1`ã€`test_scenario2`ã€`test_scenario3`ç­‰ä¸‰ä¸ªæµ‹è¯•ç›®å½•ï¼Œæ¯ä¸ªç›®å½•ä¸‹è¿˜æœ‰è‹¥å¹²æµ‹è¯•æ¨¡å—ï¼Œä½ å¸Œæœ›è¿™ä¸‰ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰æµ‹è¯•caseåˆ†åˆ«ç”±ä¸‰ä¸ªå­çº¿ç¨‹æ¥ç®¡æ‰§è¡Œï¼Œé‚£ä¹ˆåªéœ€è¦ï¼š

- cliï¼š`arun --mt --dist-suite testcases\test_scenario`ï¼Œå³å‘Šè¯‰`aomaker`æµ‹è¯•å¥—ä»¶æ‰€åœ¨ç›®å½•æ—¢å¯
- run.py: 

_run.py_

```python
from login import Login

from aomaker.runner import threads_run

if __name__ == '__main__':
    # æ³¨æ„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²
    threads_run("testcases/test_scenario", login=Login())
```

**æ³¨æ„ï¼š**

**1.æ¯ä¸ªæµ‹è¯•æ¨¡å—ä¸‹çš„caseï¼Œä¸€å®šè¦ä¿è¯æ˜¯ç‹¬ç«‹çš„ï¼**

**2.æŒ‡å®šç›®å½•ä¸‹æœ‰å¤šå°‘ä¸ªæµ‹è¯•å¥—ä»¶ï¼Œå°±å¼€å¯å¤šå°‘ä¸ªçº¿ç¨‹**

# å¤šè¿›ç¨‹

`aomaker`ç›®å‰æš‚æ—¶ä¸æ”¯æŒåœ¨windowsä¸Šåˆ›å»ºå¤šè¿›ç¨‹ï¼Œlinuxã€macæ˜¯å®Œç¾æ”¯æŒçš„ã€‚

##### å¯åŠ¨æ–¹å¼

`aomaker`åŒæ ·æä¾›äº†ä¸¤ç§å¯åŠ¨å¤šè¿›ç¨‹ï¼š**CLI**å’Œ**run.py**

1. cli

```
multi-run:
--mp, --multi-process
specifies a multi-process running mode.
--mt, --multi-thread  specifies a multi-thread running mode.
--dist-suite DIST_SUITE
specifies a dist mode for per worker.
--dist-file DIST_FILE
specifies a dist mode for per worker.
--dist-mark DIST_MARK [DIST_MARK ...]
specifies a dist mode for per worker.

```

å‘½ä»¤è¡Œè¾“å…¥ï¼š`arun --mp --dist-xxx xxx`æˆ–è€…`aomaker run --mp --dist-xxx`
**æ³¨æ„ğŸ“¢ï¼šä½¿ç”¨markåˆ†é…æ¨¡å¼æ—¶ï¼Œéœ€è¦åŠ å¼•å·ï¼Œå¦‚arun --mp --dist-mark "m1 m2 m3" **

2. run.py

_run.py_

```python
from login import Login

from aomaker.runner import processes_run

if __name__ == '__main__':
    processes_run(['-m ehpc','-m hpc'], login=Login())
```

##### åˆ†é…æ¨¡å¼

åˆ†é…æ¨¡å¼å’Œå¤šçº¿ç¨‹æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«æ˜¯ä»»åŠ¡æ˜¯åˆ†é…ç»™å­è¿›ç¨‹ï¼Œè€Œä¸æ˜¯å­çº¿ç¨‹ï¼Œå…·ä½“åˆ†é…æ¨¡å¼è¯·å‚è€ƒå¤šçº¿ç¨‹ã€‚

# workerç­–ç•¥åˆ†é…é…ç½®

å½“æˆ‘ä»¬çš„ç”¨ä¾‹å·¥ç¨‹æ¯”è¾ƒåºå¤§æ—¶ï¼Œéœ€è¦åŒæ—¶å¹¶è¡Œå¾ˆå¤šä¸åŒçš„markç”¨ä¾‹ï¼Œå¦‚`arun --mp --dist-mark "m1 m2 m3 ...m30"`ï¼Œåœ¨clié‡ŒæŒ‡å®šä¼šå¯¼è‡´å‘½ä»¤å¾ˆé•¿ã€‚

å› æ­¤ï¼Œaomakeråœ¨v2.3.0æ¨å‡ºäº†å¤šä»»åŠ¡workerç­–ç•¥é…ç½®ï¼Œç›®çš„æ˜¯æ”¯æŒæ›´å¤šæ ‡ç­¾å¹¶è¡Œæ‰§è¡Œï¼Œå¯ä»¥æ›´çµæ´»ã€æ›´æ–¹ä¾¿çš„å»é…ç½®å¤šä»»åŠ¡åˆ†é…ç­–ç•¥ï¼Œä»è€Œæå‡æ‰§è¡Œæ•ˆç‡ã€‚

åœ¨`conf`ç›®å½•ä¸‹æœ‰ä¸€ä¸ªç­–ç•¥é…ç½®æ–‡ä»¶ï¼š`aomaker.yaml`ã€‚

*conf/aomaker.yaml*
```yaml
target: ['iaas','hpc']
marks:
  iaas:
      - iaas_image
      - iaas_volume
  hpc:
    - hpc_sw
    - hpc_fs
    
```
å‚æ•°è¯´æ˜ï¼š

- targetï¼šlistï¼Œä»£è¡¨ä¸‹æ–¹å…·ä½“ç­–ç•¥ç›®æ ‡
- marksï¼šdict[dict]ï¼Œä»£è¡¨æ ‡ç­¾åˆ†ç±»ï¼Œæ¯ä¸ªåˆ†ç±»ä¸‹æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€ä¸ªæµ‹è¯•æ ‡ç­¾ã€‚

ä¸Šè¿°ç­–ç•¥é…ç½®ï¼Œæœ€ç»ˆä¼šç”Ÿäº§4ä¸ªæ ‡ç­¾ï¼šiaas_imageï¼Œiaas_volumeï¼Œhpc_swï¼Œhpc_fsï¼Œåˆ†é…ç»™4ä¸ªworkeråŒæ—¶æ‰§è¡Œã€‚

**æ³¨æ„ğŸ“¢ï¼šè¿™é‡Œé…ç½®çš„æ¯ä¸€ä¸ªæ ‡ç­¾ï¼Œä¸€å®šæ˜¯ç‹¬ç«‹ã€ä¸äº’ä¸ºä¾èµ–çš„ï¼**

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½æœ‰ä¸åŒçš„æµ‹è¯•åœºæ™¯ï¼Œéœ€è¦è·‘ä¸åŒçš„ç”¨ä¾‹ï¼Œå³ä¸åŒçš„æ ‡ç­¾ï¼Œåˆä¸æƒ³æ¯æ¬¡é‡æ–°é…ç½®ã€‚æ‰€ä»¥åœ¨æ­¤åŸºç¡€ä¸Šï¼Œè¿˜æ”¯æŒ**å¤šç­–ç•¥é…ç½®ï¼Œ**å…·ä½“ç”¨æ³•å¦‚ä¸‹ï¼š

*conf/aomaker.yaml*
```yaml
target: ['iaas.smoke','hpc']
marks:
  iaas:
    smoke:
      - iaas_image
      - iaas_volume
    p2:
      - iaas_image_p2
      - iaas_volume_p2
      - iaas_network_p2
 
  hpc:
    - hpc_sw
    - hpc_fs
    
```
æ¯”å¦‚iaasåˆ†ç±»ä¸‹ï¼Œæƒ³å¢åŠ ä¸¤ç»„å¤šä»»åŠ¡ç­–ç•¥ï¼šä¸€ç»„ç”¨æ¥è·‘å†’çƒŸ-smokeï¼Œä¸€ç»„ç”¨æ¥è·‘p2çº§ç”¨ä¾‹-p2ã€‚

å½“è¦è·‘iaaså†’çƒŸæ—¶ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„targetä¸ºiaas.smokeï¼›

å½“è¦è·‘iaas p2æ—¶ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ä¸­çš„targetä¸ºiaas.p2ï¼›

å‡å¦‚targetä¸º['iaas.p2','hpc']ï¼Œæœ€ç»ˆä¼šç”Ÿäº§5ä¸ªæ ‡ç­¾ï¼šiaas_image_p2ï¼Œiaas_volume_p2ï¼Œiaas_network_p2ï¼Œhpc_swï¼Œhpc_fsï¼Œåˆ†é…ç»™5ä¸ªworkeråŒæ—¶æ‰§è¡Œã€‚

åŸæœ‰çš„ä¸‰ç§åˆ†é…æ¨¡å¼ä¾ç„¶æ”¯æŒï¼Œå³`--dist-markï¼Œ--dist-fileï¼Œ--dist-suiteã€‚`

ç°åœ¨ï¼Œå½“ä½ æƒ³ä½¿ç”¨ç­–ç•¥é…ç½®æ—¶ï¼Œåªéœ€åœ¨å‘½ä»¤è¡Œè¾“å…¥ï¼š
- å¤šè¿›ç¨‹ï¼š `aurn --mp`
- å¤šçº¿ç¨‹ï¼š`arun --mt`


**å³,å½“ä¸è¾“å…¥åˆ†é…æ¨¡å¼å‚æ•°æ—¶ï¼Œä¼šæ ¹æ®ç­–ç•¥é…ç½®æ–‡ä»¶å»è·å–ä»»åŠ¡åˆ†é…ç»™workerï¼›**

**å½“è¾“å…¥åˆ†é…æ¨¡å¼å‚æ•°æ—¶ï¼Œä¼šæŒ‰ç…§è¾“å…¥çš„å‚æ•°å»åˆ†é…ç»™wokerã€‚**